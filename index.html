<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditory N-Back</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            min-height: 100vh;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { width: 100%; max-width: 500px; padding: 20px; }
        h1 { text-align: center; font-size: 1.6rem; margin-bottom: 8px; color: #00d9ff; }
        .subtitle { text-align: center; color: #555; margin-bottom: 30px; font-size: 0.85rem; }
        .settings { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .setting { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .setting label { font-size: 0.75rem; color: #666; text-transform: uppercase; }
        select {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            color: #fff; padding: 10px 15px; border-radius: 8px; font-size: 1rem; min-width: 90px;
        }
        .toggle-container { display: flex; align-items: center; gap: 10px; }
        .toggle {
            width: 50px; height: 26px; background: rgba(255,255,255,0.1);
            border-radius: 13px; position: relative; cursor: pointer;
            transition: background 0.3s;
        }
        .toggle.active { background: #00ff88; }
        .toggle::after {
            content: ''; position: absolute; width: 22px; height: 22px;
            background: #fff; border-radius: 50%; top: 2px; left: 2px;
            transition: transform 0.3s;
        }
        .toggle.active::after { transform: translateX(24px); }
        .display { text-align: center; margin-bottom: 30px; }
        .letter {
            font-size: 6rem; font-weight: 200; height: 180px;
            display: flex; align-items: center; justify-content: center;
            color: #00d9ff; text-shadow: 0 0 30px rgba(0,217,255,0.5); text-transform: uppercase;
        }
        .letter.countdown { color: #ff8800; text-shadow: 0 0 30px rgba(255,136,0,0.5); }
        .letter.practice-mode { color: #00ff88; text-shadow: 0 0 30px rgba(0,255,136,0.5); }
        .stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 20px; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 300; color: #00d9ff; }
        .stat-label { font-size: 0.7rem; color: #555; text-transform: uppercase; }
        .stat.practice .stat-value { color: #00ff88; }
        .feedback { text-align: center; height: 24px; font-size: 0.85rem; margin-bottom: 15px; }
        .feedback.hit { color: #00ff88; }
        .feedback.miss { color: #ff4444; }
        .feedback.false-alarm { color: #ff8800; }
        .feedback.correct-rejection { color: #00d9ff; }
        .buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-response {
            width: 120px; height: 60px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn-response:active { transform: scale(0.95); }
        .btn-response:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-match { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; }
        .btn-no-match { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: #fff; }
        .controls { display: flex; justify-content: center; gap: 15px; }
        .btn-control { 
            padding: 12px 30px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: none;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-start { background: #00d9ff; color: #000; font-weight: 600; }
        .btn-stop { background: #ff4444; color: #fff; display: none; }
        .hint { text-align: center; color: #333; font-size: 0.75rem; margin-top: 25px; }
        .hint kbd { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; }
        .history { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .history-label { font-size: 0.7rem; color: #444; text-transform: uppercase; margin-bottom: 8px; }
        .history-letters { font-family: monospace; font-size: 1rem; color: #666; letter-spacing: 2px; word-wrap: break-word; }
        .history-letters .current { color: #00d9ff; font-weight: bold; }
        .history-letters .match-position { color: #00ff88; }
        .practice-banner {
            background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3);
            padding: 8px 15px; border-radius: 8px; text-align: center;
            color: #00ff88; font-size: 0.8rem; margin-bottom: 20px; display: none;
        }
        .practice-banner.visible { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Auditory N-Back</h1>
        <p class="subtitle">Piano Tones</p>

```
    <div class="practice-banner" id="practiceBanner">
        ðŸŽ¯ PRACTICE MODE â€” No scoring, learn the rhythm
    </div>
    
    <div class="settings" id="settings">
        <div class="setting">
            <label>N-Back</label>
            <select id="nBack">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
            </select>
        </div>
        <div class="setting">
            <label>Interval (sec)</label>
            <select id="interval">
                <option value="2.5">2.5</option>
                <option value="3" selected>3</option>
                <option value="3.5">3.5</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="10">10</option>
                <option value="12">12</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
                <option value="30">30</option>
            </select>
        </div>
        <div class="setting">
            <label>Practice</label>
            <div class="toggle-container">
                <div class="toggle" id="practiceToggle"></div>
            </div>
        </div>
    </div>
    
    <div class="display">
        <div class="letter" id="letter">â€”</div>
    </div>
    
    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="trial">0</div>
            <div class="stat-label">Trial</div>
        </div>
        <div class="stat" id="accuracyStat">
            <div class="stat-value" id="accuracy">â€”</div>
            <div class="stat-label">Accuracy</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="hits">0</div>
            <div class="stat-label">Hits</div>
        </div>
    </div>
    
    <div class="feedback" id="feedback"></div>
    
    <div class="buttons">
        <button class="btn-response btn-match" id="btnMatch" disabled>MATCH</button>
        <button class="btn-response btn-no-match" id="btnNoMatch" disabled>NO MATCH</button>
    </div>
    
    <div class="controls">
        <button class="btn-control btn-start" id="btnStart">Start</button>
        <button class="btn-control btn-stop" id="btnStop">Stop</button>
    </div>
    
    <div class="hint">
        <kbd>M</kbd> Match | <kbd>N</kbd> No Match | <kbd>Space</kbd> Start/Stop
    </div>
    
    <div class="history">
        <div class="history-label">Sequence</div>
        <div class="history-letters" id="historyLetters">â€”</div>
    </div>
</div>

<script>
    // ========================================
    // STATE
    // ========================================
    var running = false;
    var trialNum = 0;
    var sequence = [];
    var hits = 0;
    var misses = 0;
    var falseAlarms = 0;
    var correctRejections = 0;
    var responded = false;
    var nextTrialTimeout = null;
    var practiceMode = false;
    
    // ========================================
    // AUDIO CONTEXT
    // ========================================
    var audioCtx = null;
    var masterGain = null;
    var reverbNode = null;
    var reverbGain = null;
    var dryGain = null;
    
    // ========================================
    // PIANO NOTES - 12 well-spaced notes
    // Using arpeggiated pattern for maximum distinctness
    // Range: C3 to D6 (comfortable, clear hearing range)
    // ========================================
    var NOTES = [
        { name: 'C3',  freq: 130.81, label: '1' },
        { name: 'E3',  freq: 164.81, label: '2' },
        { name: 'G3',  freq: 196.00, label: '3' },
        { name: 'B3',  freq: 246.94, label: '4' },
        { name: 'D4',  freq: 293.66, label: '5' },
        { name: 'F#4', freq: 369.99, label: '6' },
        { name: 'A4',  freq: 440.00, label: '7' },
        { name: 'C5',  freq: 523.25, label: '8' },
        { name: 'E5',  freq: 659.25, label: '9' },
        { name: 'G5',  freq: 783.99, label: '10' },
        { name: 'B5',  freq: 987.77, label: '11' },
        { name: 'D6',  freq: 1174.66, label: '12' }
    ];

    // ========================================
    // GETTERS
    // ========================================
    function getNBack() { 
        return parseInt(document.getElementById('nBack').value); 
    }
    
    function getIntervalMs() { 
        return parseFloat(document.getElementById('interval').value) * 1000; 
    }

    // ========================================
    // AUDIO INITIALIZATION
    // ========================================
    function initAudio() {
        if (audioCtx) {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return;
        }
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Master output
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.8;
        masterGain.connect(audioCtx.destination);
        
        // Dry path
        dryGain = audioCtx.createGain();
        dryGain.gain.value = 0.7;
        dryGain.connect(masterGain);
        
        // Reverb path
        reverbNode = audioCtx.createConvolver();
        reverbNode.buffer = createReverbBuffer(2.2, 2.5);
        
        reverbGain = audioCtx.createGain();
        reverbGain.gain.value = 0.35;
        reverbNode.connect(reverbGain);
        reverbGain.connect(masterGain);
    }
    
    // ========================================
    // CREATE REVERB IMPULSE RESPONSE
    // Simulates a warm concert hall
    // ========================================
    function createReverbBuffer(duration, decay) {
        var length = audioCtx.sampleRate * duration;
        var buffer = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
        var left = buffer.getChannelData(0);
        var right = buffer.getChannelData(1);
        
        for (var i = 0; i < length; i++) {
            var t = i / audioCtx.sampleRate;
            // Exponential decay with early reflections
            var envelope = Math.exp(-t * decay);
            // Add some early reflection bumps
            if (t < 0.1) {
                envelope *= (1 + 0.5 * Math.sin(t * 100));
            }
            var noise = (Math.random() * 2 - 1);
            left[i] = noise * envelope;
            right[i] = (Math.random() * 2 - 1) * envelope;
        }
        
        return buffer;
    }

    // ========================================
    // KARPLUS-STRONG STRING SYNTHESIS
    // Creates realistic plucked/struck string sound
    // ========================================
    function createKarplusStrongBuffer(freq, duration, brightness, pluckPosition) {
        var sampleRate = audioCtx.sampleRate;
        var numSamples = Math.floor(sampleRate * duration);
        var buffer = audioCtx.createBuffer(1, numSamples, sampleRate);
        var data = buffer.getChannelData(0);
        
        // Delay line length determines pitch
        var delayLength = Math.round(sampleRate / freq);
        var delayLine = new Float32Array(delayLength);
        
        // Initialize delay line with excitation signal
        // Mix of noise and harmonic content for piano-like attack
        for (var i = 0; i < delayLength; i++) {
            var pos = i / delayLength;
            
            // Pluck position shapes initial harmonics
            // Plucking near center emphasizes fundamental
            var pluckShape = Math.sin(Math.PI * pos / pluckPosition) * 
                             Math.sin(Math.PI * pos);
            
            // Mix noise with shaped waveform
            var noise = (Math.random() * 2 - 1) * 0.6;
            var shaped = pluckShape * 0.4;
            
            delayLine[i] = noise + shaped;
        }
        
        // Low-pass filter state for Karplus-Strong
        var filterState = 0;
        var damping = brightness; // 0.0 = very dark, 1.0 = bright
        
        // Process
        var readPos = 0;
        for (var i = 0; i < numSamples; i++) {
            // Read from delay line
            var sample = delayLine[readPos];
            
            // Output
            data[i] = sample;
            
            // Low-pass filter (averaging filter with damping control)
            var nextPos = (readPos + 1) % delayLength;
            var nextSample = delayLine[nextPos];
            
            // Weighted average for low-pass effect
            // Higher damping = brighter sound
            var filtered = filterState * (1 - damping) + 
                           ((sample + nextSample) * 0.5) * damping;
            filterState = filtered;
            
            // Write back to delay line with slight decay
            delayLine[readPos] = filtered * 0.996;
            
            readPos = nextPos;
        }
        
        return buffer;
    }

    // ========================================
    // PLAY PIANO NOTE
    // Uses multiple detuned Karplus-Strong strings
    // with envelope shaping for piano character
    // ========================================
    function playPianoTone(noteIndex) {
        if (!audioCtx) return;
        
        var note = NOTES[noteIndex];
        var freq = note.freq;
        var now = audioCtx.currentTime;
        
        // Duration varies by pitch (lower = longer)
        var baseDuration = 3.5;
        var duration = baseDuration * Math.pow(300 / freq, 0.25);
        duration = Math.max(2.0, Math.min(duration, 5.0));
        
        // Brightness varies by pitch (higher notes brighter)
        var brightness = 0.4 + (freq / 1200) * 0.35;
        brightness = Math.min(0.75, brightness);
        
        // Create note output node
        var noteGain = audioCtx.createGain();
        
        // Piano envelope: soft attack, natural decay
        var attackTime = 0.008;
        var peakTime = 0.03;
        var decayTime = duration - peakTime;
        
        noteGain.gain.setValueAtTime(0, now);
        noteGain.gain.linearRampToValueAtTime(0.5, now + attackTime);
        noteGain.gain.linearRampToValueAtTime(0.4, now + peakTime);
        noteGain.gain.exponentialRampToValueAtTime(0.001, now + duration);
        
        noteGain.connect(dryGain);
        noteGain.connect(reverbNode);
        
        // Create 3 slightly detuned strings (like real piano)
        var detunings = [-0.8, 0, 0.8]; // cents
        var stringGains = [0.33, 0.4, 0.33];
        
        for (var s = 0; s < 3; s++) {
            // Detune frequency
            var detunedFreq = freq * Math.pow(2, detunings[s] / 1200);
            
            // Slightly different pluck positions for each string
            var pluckPos = 0.12 + (s * 0.02) + (Math.random() * 0.02);
            
            // Create the string buffer
            var stringBuffer = createKarplusStrongBuffer(
                detunedFreq, 
                duration + 0.1, 
                brightness + (Math.random() * 0.05 - 0.025),
                pluckPos
            );
            
            // Play string
            var stringSource = audioCtx.createBufferSource();
            stringSource.buffer = stringBuffer;
            
            var stringGain = audioCtx.createGain();
            stringGain.gain.value = stringGains[s];
            
            stringSource.connect(stringGain);
            stringGain.connect(noteGain);
            
            // Slight timing variation between strings
            var startOffset = s * 0.002 * Math.random();
            stringSource.start(now + startOffset);
            stringSource.stop(now + duration + 0.2);
        }
        
        // Add hammer noise (very subtle)
        addHammerNoise(noteGain, freq, now);
    }
    
    // ========================================
    // ADD HAMMER NOISE
    // Subtle attack transient
    // ========================================
    function addHammerNoise(destination, freq, startTime) {
        var noiseDuration = 0.025;
        var noiseLength = Math.floor(audioCtx.sampleRate * noiseDuration);
        var noiseBuffer = audioCtx.createBuffer(1, noiseLength, audioCtx.sampleRate);
        var noiseData = noiseBuffer.getChannelData(0);
        
        // Shaped noise burst
        for (var i = 0; i < noiseLength; i++) {
            var t = i / noiseLength;
            // Quick attack, quick decay
            var env = Math.sin(t * Math.PI) * Math.exp(-t * 8);
            noiseData[i] = (Math.random() * 2 - 1) * env;
        }
        
        var noiseSource = audioCtx.createBufferSource();
        noiseSource.buffer = noiseBuffer;
        
        // Bandpass filter centered on note frequency
        var filter = audioCtx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = freq * 1.5;
        filter.Q.value = 1.0;
        
        var noiseGain = audioCtx.createGain();
        noiseGain.gain.value = 0.12;
        
        noiseSource.connect(filter);
        filter.connect(noiseGain);
        noiseGain.connect(destination);
        
        noiseSource.start(startTime);
        noiseSource.stop(startTime + noiseDuration);
    }
    
    // ========================================
    // COUNTDOWN TONE - Gentle bell
    // ========================================
    function playCountdownTone(pitch) {
        if (!audioCtx) return;
        
        var now = audioCtx.currentTime;
        var duration = 0.4;
        
        var osc = audioCtx.createOscillator();
        var osc2 = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        
        osc.type = 'sine';
        osc.frequency.value = pitch;
        osc2.type = 'sine';
        osc2.frequency.value = pitch * 2.4;
        
        var gain2 = audioCtx.createGain();
        gain2.gain.value = 0.15;
        
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.15, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
        
        osc.connect(gain);
        osc2.connect(gain2);
        gain2.connect(gain);
        gain.connect(masterGain);
        
        osc.start(now);
        osc.stop(now + duration);
        osc2.start(now);
        osc2.stop(now + duration);
    }

    // ========================================
    // CORE LOGIC
    // ========================================
    function isCurrentMatch() {
        var n = getNBack();
        if (sequence.length <= n) return false;
        return sequence[sequence.length - 1] === sequence[sequence.length - 1 - n];
    }

    function pickNote() {
        var n = getNBack();
        
        // Need at least n items to have a target
        if (sequence.length >= n) {
            var roll = Math.random();
            var target = sequence[sequence.length - n];
            
            // 30% - Exact n-back target
            if (roll < 0.30) {
                return target;
            }
            
            // 25% - Lure trials (nÂ±1 positions) for cognitive interference
            // Creates uncertainty: "Was that 2-back or 3-back?"
            if (roll < 0.55) {
                var lures = [];
                
                // n-1 lure: one position MORE RECENT than target
                // e.g., for 2-back, this would be 1-back
                if (n > 1) {
                    var lure1 = sequence[sequence.length - n + 1];
                    if (lure1 !== target) {
                        lures.push(lure1);
                    }
                }
                
                // n+1 lure: one position OLDER than target
                // e.g., for 2-back, this would be 3-back
                if (sequence.length > n) {
                    var lure2 = sequence[sequence.length - n - 1];
                    if (lure2 !== target) {
                        lures.push(lure2);
                    }
                }
                
                // Return random lure if available
                if (lures.length > 0) {
                    return lures[Math.floor(Math.random() * lures.length)];
                }
            }
        }
        
        // Random note (remaining ~45%)
        return Math.floor(Math.random() * NOTES.length);
    }

    // ========================================
    // UI UPDATES
    // ========================================
    function updateHistory() {
        var n = getNBack();
        var el = document.getElementById('historyLetters');
        if (sequence.length === 0) { 
            el.textContent = 'â€”'; 
            return; 
        }
        var html = '';
        for (var i = 0; i < sequence.length; i++) {
            var noteName = NOTES[sequence[i]].name;
            if (i === sequence.length - 1) {
                html += '<span class="current">' + noteName + '</span>';
            } else if (i === sequence.length - 1 - n && sequence.length > n) {
                html += '<span class="match-position">' + noteName + '</span>';
            } else {
                html += noteName;
            }
            if (i < sequence.length - 1) html += ' ';
        }
        el.innerHTML = html;
    }

    function showFeedback(text, cls) {
        var el = document.getElementById('feedback');
        el.textContent = text;
        el.className = 'feedback ' + cls;
    }
    
    function clearFeedback() {
        var el = document.getElementById('feedback');
        el.textContent = '';
        el.className = 'feedback';
    }

    function updateAccuracy() {
        var total = hits + misses + falseAlarms + correctRejections;
        var el = document.getElementById('accuracy');
        if (total === 0) { 
            el.textContent = 'â€”'; 
            return; 
        }
        var acc = Math.round(((hits + correctRejections) / total) * 100);
        el.textContent = acc + '%';
    }

    // ========================================
    // SCORING
    // ========================================
    function evaluatePreviousTrial() {
        if (practiceMode) return;
        
        var n = getNBack();
        if (sequence.length > n + 1 && !responded) {
            var prevIndex = sequence.length - 2;
            var wasMatch = sequence[prevIndex] === sequence[prevIndex - n];
            if (wasMatch) {
                misses++;
            } else {
                correctRejections++;
            }
            updateAccuracy();
        }
    }

    // ========================================
    // TRIAL EXECUTION
    // ========================================
    function runTrial() {
        if (!running) return;
        
        if (trialNum > 0) {
            evaluatePreviousTrial();
        }
        
        clearFeedback();
        
        trialNum++;
        responded = false;
        
        var noteIndex = pickNote();
        sequence.push(noteIndex);
        
        document.getElementById('trial').textContent = trialNum;
        
        var canRespond = sequence.length > getNBack();
        document.getElementById('btnMatch').disabled = !canRespond;
        document.getElementById('btnNoMatch').disabled = !canRespond;
        
        var letterEl = document.getElementById('letter');
        
        // Play piano tone
        playPianoTone(noteIndex);
        
        // Show visual after delay
        setTimeout(function() {
            if (running) {
                letterEl.textContent = NOTES[noteIndex].name;
                if (practiceMode) {
                    letterEl.className = 'letter practice-mode';
                } else {
                    letterEl.className = 'letter';
                }
                updateHistory();
            }
        }, 600);
        
        // Schedule next trial
        nextTrialTimeout = setTimeout(runTrial, getIntervalMs());
    }

    // ========================================
    // RESPONSE HANDLING
    // ========================================
    function respond(isMatchResponse) {
        if (!running) return;
        if (responded) return;
        if (sequence.length <= getNBack()) return;
        
        responded = true;
        var wasActualMatch = isCurrentMatch();
        
        if (practiceMode) {
            if (isMatchResponse && wasActualMatch) {
                showFeedback('âœ“ Correct - It was a match!', 'hit');
            } else if (isMatchResponse && !wasActualMatch) {
                showFeedback('âœ— Not a match', 'false-alarm');
            } else if (!isMatchResponse && wasActualMatch) {
                showFeedback('âœ— It WAS a match!', 'miss');
            } else {
                showFeedback('âœ“ Correct - Not a match', 'correct-rejection');
            }
        } else {
            if (isMatchResponse && wasActualMatch) {
                hits++;
                showFeedback('âœ“ Hit!', 'hit');
            } else if (isMatchResponse && !wasActualMatch) {
                falseAlarms++;
                showFeedback('âœ— False Alarm', 'false-alarm');
            } else if (!isMatchResponse && wasActualMatch) {
                misses++;
                showFeedback('âœ— Miss', 'miss');
            } else {
                correctRejections++;
                showFeedback('âœ“ Correct Rejection', 'correct-rejection');
            }
            document.getElementById('hits').textContent = hits;
            updateAccuracy();
        }
    }

    // ========================================
    // COUNTDOWN
    // ========================================
    function startCountdown(onComplete) {
        var letterEl = document.getElementById('letter');
        letterEl.className = 'letter countdown';
        
        letterEl.textContent = '3';
        playCountdownTone(660);
        
        setTimeout(function() {
            letterEl.textContent = '2';
            playCountdownTone(660);
        }, 1000);
        
        setTimeout(function() {
            letterEl.textContent = '1';
            playCountdownTone(660);
        }, 2000);
        
        setTimeout(function() {
            letterEl.textContent = '0';
            playCountdownTone(880);
        }, 3000);
        
        setTimeout(function() {
            letterEl.textContent = 'â€”';
            letterEl.className = 'letter';
            onComplete();
        }, 4000);
    }

    // ========================================
    // GAME CONTROL
    // ========================================
    function startGame() {
        initAudio();
        
        trialNum = 0;
        sequence = [];
        hits = 0;
        misses = 0;
        falseAlarms = 0;
        correctRejections = 0;
        responded = false;
        
        document.getElementById('letter').textContent = 'â€”';
        document.getElementById('letter').className = 'letter';
        document.getElementById('trial').textContent = '0';
        document.getElementById('accuracy').textContent = 'â€”';
        document.getElementById('hits').textContent = '0';
        clearFeedback();
        document.getElementById('historyLetters').textContent = 'â€”';
        
        document.getElementById('btnStart').style.display = 'none';
        document.getElementById('btnStop').style.display = 'inline-block';
        
        document.getElementById('settings').style.opacity = '0.5';
        document.getElementById('settings').style.pointerEvents = 'none';
        
        if (practiceMode) {
            document.getElementById('practiceBanner').classList.add('visible');
            document.getElementById('accuracyStat').classList.add('practice');
        }
        
        running = true;
        
        startCountdown(function() {
            if (running) {
                runTrial();
            }
        });
    }

    function stopGame() {
        running = false;
        
        if (nextTrialTimeout) {
            clearTimeout(nextTrialTimeout);
            nextTrialTimeout = null;
        }
        
        document.getElementById('letter').className = 'letter';
        document.getElementById('btnStart').style.display = 'inline-block';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('settings').style.opacity = '1';
        document.getElementById('settings').style.pointerEvents = 'auto';
        document.getElementById('btnMatch').disabled = true;
        document.getElementById('btnNoMatch').disabled = true;
        document.getElementById('practiceBanner').classList.remove('visible');
        document.getElementById('accuracyStat').classList.remove('practice');
        
        if (!practiceMode) {
            var total = hits + misses + falseAlarms + correctRejections;
            if (total > 0) {
                var finalAcc = Math.round(((hits + correctRejections) / total) * 100);
                showFeedback('Final: ' + finalAcc + '% (' + hits + ' hits, ' + misses + ' misses)', 
                             finalAcc >= 80 ? 'hit' : 'miss');
            }
        }
    }

    // ========================================
    // PRACTICE MODE TOGGLE
    // ========================================
    function togglePracticeMode() {
        practiceMode = !practiceMode;
        var toggle = document.getElementById('practiceToggle');
        if (practiceMode) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    document.getElementById('btnMatch').onclick = function() { 
        respond(true); 
    };
    
    document.getElementById('btnNoMatch').onclick = function() { 
        respond(false); 
    };
    
    document.getElementById('btnStart').onclick = startGame;
    document.getElementById('btnStop').onclick = stopGame;
    document.getElementById('practiceToggle').onclick = togglePracticeMode;

    document.onkeydown = function(e) {
        var key = e.key.toLowerCase();
        if (key === 'm') {
            respond(true);
        } else if (key === 'n') {
            respond(false);
        } else if (key === ' ') {
            e.preventDefault();
            if (running) {
                stopGame();
            } else {
                startGame();
            }
        }
    };
</script>
```

</body>
</html>
