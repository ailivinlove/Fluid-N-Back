<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditory N-Back</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            min-height: 100vh;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { width: 100%; max-width: 500px; padding: 20px; }
        h1 { text-align: center; font-size: 1.6rem; margin-bottom: 8px; color: #00d9ff; }
        .subtitle { text-align: center; color: #555; margin-bottom: 30px; font-size: 0.85rem; }
        .settings { display: flex; justify-content: center; gap: 25px; margin-bottom: 30px; }
        .setting { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .setting label { font-size: 0.75rem; color: #666; text-transform: uppercase; }
        select {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            color: #fff; padding: 10px 15px; border-radius: 8px; font-size: 1rem; width: 100px;
        }
        .display { text-align: center; margin-bottom: 30px; }
        .letter {
            font-size: 8rem; font-weight: 200; height: 180px;
            display: flex; align-items: center; justify-content: center;
            color: #00d9ff; text-shadow: 0 0 30px rgba(0,217,255,0.5); text-transform: uppercase;
        }
        .letter.countdown { color: #ff8800; }
        .stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 20px; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 300; color: #00d9ff; }
        .stat-label { font-size: 0.7rem; color: #555; text-transform: uppercase; }
        .feedback { text-align: center; height: 24px; font-size: 0.85rem; margin-bottom: 15px; }
        .feedback.hit { color: #00ff88; }
        .feedback.miss { color: #ff4444; }
        .feedback.false-alarm { color: #ff8800; }
        .feedback.correct-rejection { color: #00d9ff; }
        .buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-response {
            width: 120px; height: 60px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-response:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-match { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; }
        .btn-no-match { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: #fff; }
        .controls { display: flex; justify-content: center; gap: 15px; }
        .btn-control { 
            padding: 12px 30px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: none;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-start { background: #00d9ff; color: #000; font-weight: 600; }
        .btn-stop { background: #ff4444; color: #fff; display: none; }
        .hint { text-align: center; color: #333; font-size: 0.75rem; margin-top: 25px; }
        .hint kbd { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; }
        .history { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .history-label { font-size: 0.7rem; color: #444; text-transform: uppercase; margin-bottom: 8px; }
        .history-letters { font-family: monospace; font-size: 1.1rem; color: #666; letter-spacing: 4px; text-transform: uppercase; }
        .history-letters .current { color: #00d9ff; font-weight: bold; }
        .history-letters .match-position { color: #00ff88; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Auditory N-Back</h1>
        <p class="subtitle">Traditional Version</p>
        <div class="settings" id="settings">
            <div class="setting">
                <label>N-Back</label>
                <select id="nBack">
                    <option value="1">1</option><option value="2" selected>2</option>
                    <option value="3">3</option><option value="4">4</option>
                    <option value="5">5</option><option value="6">6</option>
                </select>
            </div>
            <div class="setting">
                <label>Interval (sec)</label>
                <select id="interval">
                    <option value="2">2</option><option value="2.5">2.5</option>
                    <option value="3" selected>3</option><option value="3.5">3.5</option>
                    <option value="4">4</option><option value="5">5</option>
                </select>
            </div>
        </div>
        <div class="display"><div class="letter" id="letter">—</div></div>
        <div class="stats">
            <div class="stat"><div class="stat-value" id="trial">0</div><div class="stat-label">Trial</div></div>
            <div class="stat"><div class="stat-value" id="accuracy">—</div><div class="stat-label">Accuracy</div></div>
            <div class="stat"><div class="stat-value" id="hits">0</div><div class="stat-label">Hits</div></div>
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="buttons">
            <button class="btn-response btn-match" id="btnMatch" disabled>MATCH</button>
            <button class="btn-response btn-no-match" id="btnNoMatch" disabled>NO MATCH</button>
        </div>
        <div class="controls">
            <button class="btn-control btn-start" id="btnStart">Start</button>
            <button class="btn-control btn-stop" id="btnStop">Stop</button>
        </div>
        <div class="hint"><kbd>M</kbd> Match | <kbd>N</kbd> No Match | <kbd>Space</kbd> Start/Stop</div>
        <div class="history">
            <div class="history-label">Sequence</div>
            <div class="history-letters" id="historyLetters">—</div>
        </div>
    </div>

```
<script>
    var running = false;
    var trialNum = 0;
    var sequence = [];
    var hits = 0, misses = 0, falseAlarms = 0, correctRejections = 0;
    var responded = false;
    var timerId = null;
    var synth = window.speechSynthesis;

    var LETTERS = ['b','c','d','f','g','h','j','k','l','m','n','p','r','s','t','v','w','x','z'];

    function getNBack() { return parseInt(document.getElementById('nBack').value); }
    function getIntervalMs() { return parseFloat(document.getElementById('interval').value) * 1000; }

    function isCurrentMatch() {
        var n = getNBack();
        if (sequence.length <= n) return false;
        return sequence[sequence.length - 1] === sequence[sequence.length - 1 - n];
    }

    function pickLetter() {
        var n = getNBack();
        if (sequence.length >= n && Math.random() < 0.3) {
            return sequence[sequence.length - n];
        }
        return LETTERS[Math.floor(Math.random() * LETTERS.length)];
    }

    function updateHistory() {
        var n = getNBack();
        var el = document.getElementById('historyLetters');
        if (sequence.length === 0) { el.textContent = '—'; return; }
        var html = '';
        for (var i = 0; i < sequence.length; i++) {
            if (i === sequence.length - 1) {
                html += '<span class="current">' + sequence[i] + '</span>';
            } else if (i === sequence.length - 1 - n && sequence.length > n) {
                html += '<span class="match-position">' + sequence[i] + '</span>';
            } else {
                html += sequence[i];
            }
            if (i < sequence.length - 1) html += ' ';
        }
        el.innerHTML = html;
    }

    function showFeedback(text, cls) {
        var el = document.getElementById('feedback');
        el.textContent = text;
        el.className = 'feedback ' + cls;
        setTimeout(function() { el.textContent = ''; el.className = 'feedback'; }, 1500);
    }

    function updateAccuracy() {
        var total = hits + misses + falseAlarms + correctRejections;
        var el = document.getElementById('accuracy');
        if (total === 0) { el.textContent = '—'; return; }
        el.textContent = Math.round(((hits + correctRejections) / total) * 100) + '%';
    }

    function evalPrev() {
        var n = getNBack();
        if (sequence.length > n + 1 && !responded) {
            var idx = sequence.length - 2;
            if (sequence[idx] === sequence[idx - n]) { misses++; }
            else { correctRejections++; }
            updateAccuracy();
        }
    }

    // Speak a letter - simple, no callbacks
    function speak(text) {
        var u = new SpeechSynthesisUtterance(text);
        u.rate = 0.9;
        u.pitch = 1.0;
        u.volume = 1.0;
        u.lang = 'en-US';
        synth.speak(u);
    }

    function doTrial() {
        if (!running) return;
        
        if (trialNum > 0) evalPrev();

        trialNum++;
        responded = false;
        var letter = pickLetter();
        sequence.push(letter);

        document.getElementById('trial').textContent = trialNum;
        
        var canRespond = sequence.length > getNBack();
        document.getElementById('btnMatch').disabled = !canRespond;
        document.getElementById('btnNoMatch').disabled = !canRespond;

        var letterEl = document.getElementById('letter');
        
        // First: speak the letter
        speak(letter);
        
        // Then: show visual 200ms AFTER starting speech (so audio is definitely first)
        setTimeout(function() {
            letterEl.textContent = letter;
            letterEl.className = 'letter';
            updateHistory();
        }, 200);

        // Schedule next trial at exact interval
        timerId = setTimeout(doTrial, getIntervalMs());
    }

    function respond(match) {
        if (!running || responded || sequence.length <= getNBack()) return;
        responded = true;
        var wasMatch = isCurrentMatch();
        if (match && wasMatch) { hits++; showFeedback('✓ Hit!', 'hit'); }
        else if (match && !wasMatch) { falseAlarms++; showFeedback('✗ False Alarm', 'false-alarm'); }
        else if (!match && wasMatch) { misses++; showFeedback('✗ Miss', 'miss'); }
        else { correctRejections++; showFeedback('✓ Correct Rejection', 'correct-rejection'); }
        document.getElementById('hits').textContent = hits;
        updateAccuracy();
    }

    function startGame() {
        // Reset state
        trialNum = 0;
        sequence = [];
        hits = misses = falseAlarms = correctRejections = 0;
        responded = false;

        document.getElementById('letter').textContent = '—';
        document.getElementById('trial').textContent = '0';
        document.getElementById('accuracy').textContent = '—';
        document.getElementById('hits').textContent = '0';
        document.getElementById('feedback').textContent = '';
        document.getElementById('historyLetters').textContent = '—';
        document.getElementById('btnStart').style.display = 'none';
        document.getElementById('btnStop').style.display = 'inline-block';
        document.getElementById('settings').style.opacity = '0.5';
        document.getElementById('settings').style.pointerEvents = 'none';

        var letterEl = document.getElementById('letter');
        letterEl.className = 'letter countdown';
        
        // Warm up speech engine with a silent utterance on iOS
        var warmup = new SpeechSynthesisUtterance('');
        warmup.volume = 0;
        synth.speak(warmup);

        // Countdown: 3, 2, 1, 0, then GO
        letterEl.textContent = '3';
        
        setTimeout(function() {
            letterEl.textContent = '2';
            
            setTimeout(function() {
                letterEl.textContent = '1';
                
                setTimeout(function() {
                    letterEl.textContent = '0';
                    
                    setTimeout(function() {
                        // Start game
                        letterEl.textContent = '—';
                        letterEl.className = 'letter';
                        running = true;
                        doTrial();
                    }, 1000);
                }, 1000);
            }, 1000);
        }, 1000);
    }

    function stopGame() {
        running = false;
        if (timerId) { 
            clearTimeout(timerId); 
            timerId = null; 
        }

        document.getElementById('letter').className = 'letter';
        document.getElementById('btnStart').style.display = 'inline-block';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('settings').style.opacity = '1';
        document.getElementById('settings').style.pointerEvents = 'auto';
        document.getElementById('btnMatch').disabled = true;
        document.getElementById('btnNoMatch').disabled = true;

        var total = hits + misses + falseAlarms + correctRejections;
        if (total > 0) {
            showFeedback('Final: ' + Math.round(((hits + correctRejections) / total) * 100) + '%', hits > misses ? 'hit' : 'miss');
        }
    }

    document.getElementById('btnMatch').onclick = function() { respond(true); };
    document.getElementById('btnNoMatch').onclick = function() { respond(false); };
    document.getElementById('btnStart').onclick = startGame;
    document.getElementById('btnStop').onclick = stopGame;

    document.onkeydown = function(e) {
        var key = e.key.toLowerCase();
        if (key === 'm') respond(true);
        else if (key === 'n') respond(false);
        else if (key === ' ') { e.preventDefault(); running ? stopGame() : startGame(); }
    };
</script>
```

</body>
</html>
