<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditory N-Back Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .container {
        width: 100%;
        max-width: 600px;
    }

    h1 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
        text-align: center;
        margin-bottom: 30px;
        opacity: 0.9;
        font-size: 1.1em;
    }

    .display-area {
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        padding: 80px;
        margin-bottom: 30px;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255,255,255,0.2);
    }

    .audio-indicator {
        font-size: 60px;
        margin-bottom: 20px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .audio-indicator.active {
        opacity: 1;
    }

    .instruction-text {
        font-size: 18px;
        opacity: 0.7;
        text-align: center;
    }

    .countdown {
        font-size: 80px;
        font-weight: bold;
        opacity: 0.7;
    }

    .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    button {
        flex: 1;
        padding: 18px 25px;
        font-size: 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    button:active:not(:disabled) {
        transform: translateY(0);
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-start {
        background: #27ae60;
        color: white;
    }

    .btn-stop {
        background: #e74c3c;
        color: white;
    }

    .settings {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
    }

    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .setting-row:last-child {
        margin-bottom: 0;
    }

    label {
        font-size: 16px;
        font-weight: 500;
    }

    input[type="range"] {
        width: 200px;
    }

    input[type="number"] {
        width: 80px;
        padding: 8px;
        border-radius: 5px;
        border: none;
        font-size: 16px;
    }

    .value-display {
        min-width: 60px;
        text-align: right;
        font-weight: 600;
    }

    .stats {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        text-align: center;
    }

    .stat-item {
        margin-bottom: 10px;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 36px;
        font-weight: bold;
    }

    .breath-indicator {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        min-height: 30px;
        opacity: 0.8;
    }

    .toggle-section {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .instruction {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.9;
    }

    @media (max-width: 600px) {
        .audio-indicator {
            font-size: 50px;
        }
        
        .setting-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        input[type="range"] {
            width: 100%;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>Auditory N-Back</h1>
        <div class="subtitle">Pure Listening Training</div>

```
    <div class="instruction">
        Numbers will be spoken aloud. Track matches mentallyâ€”no buttons to press.<br>
        <strong>Best in Chrome or Edge browsers for clearest audio.</strong>
    </div>

    <div class="breath-indicator" id="breathIndicator"></div>

    <div class="display-area">
        <div class="audio-indicator" id="audioIndicator">ðŸ”Š</div>
        <div class="instruction-text" id="instructionText">Press Start to begin</div>
    </div>

    <div class="controls">
        <button class="btn-start" id="startBtn">Start (Space)</button>
        <button class="btn-stop" id="stopBtn" disabled>Stop (Space)</button>
    </div>

    <div class="settings">
        <div class="setting-row">
            <label>N-Back Level:</label>
            <div class="toggle-section">
                <input type="number" id="nBackLevel" min="1" max="15" value="8">
            </div>
        </div>

        <div class="setting-row">
            <label>Interval (seconds):</label>
            <div class="toggle-section">
                <input type="range" id="intervalSlider" min="3.0" max="30" step="0.5" value="5">
                <span class="value-display" id="intervalDisplay">5.0s</span>
            </div>
        </div>

        <div class="setting-row">
            <label>Speech Rate:</label>
            <div class="toggle-section">
                <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.7">
                <span class="value-display" id="speechRateDisplay">0.7x</span>
            </div>
        </div>

        <div class="setting-row">
            <label>Breath Sync:</label>
            <input type="checkbox" id="breathSync">
        </div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-label">Trials Completed</div>
            <div class="stat-value" id="trialsCount">0</div>
        </div>
    </div>
</div>

<script>
    // Game state
    let isRunning = false;
    let currentTrial = 0;
    let trialTimeout = null;
    let breathPhase = 'inhale';
    let history = [];
    let audioContext = null;
    let speechSynthesis = window.speechSynthesis;

    // DOM elements
    const audioIndicator = document.getElementById('audioIndicator');
    const instructionText = document.getElementById('instructionText');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nBackLevel = document.getElementById('nBackLevel');
    const intervalSlider = document.getElementById('intervalSlider');
    const intervalDisplay = document.getElementById('intervalDisplay');
    const speechRate = document.getElementById('speechRate');
    const speechRateDisplay = document.getElementById('speechRateDisplay');
    const breathSync = document.getElementById('breathSync');
    const breathIndicator = document.getElementById('breathIndicator');
    const trialsCount = document.getElementById('trialsCount');

    // Load voices immediately
    speechSynthesis.getVoices();

    // Update interval display
    intervalSlider.addEventListener('input', () => {
        intervalDisplay.textContent = parseFloat(intervalSlider.value).toFixed(1) + 's';
    });

    // Update speech rate display
    speechRate.addEventListener('input', () => {
        speechRateDisplay.textContent = parseFloat(speechRate.value).toFixed(1) + 'x';
    });

    // Generate random digit
    function randomDigit() {
        return Math.floor(Math.random() * 9) + 1;
    }

    // Speak number using Web Speech API with warmup to prevent cutoff
    function speakNumber(number) {
        // Cancel any pending speech first
        speechSynthesis.cancel();
        
        // WARMUP STRATEGY: Speak a silent primer first
        const warmup = new SpeechSynthesisUtterance('.');
        warmup.volume = 0.01;  // Nearly silent
        warmup.rate = 2.0;     // Fast
        
        warmup.onend = () => {
            // Now speak the actual number after warmup
            const text = `... ... ${number} ... ...`;
            const utterance = new SpeechSynthesisUtterance(text);
            
            utterance.rate = parseFloat(speechRate.value);
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => 
                v.lang.startsWith('en') && !v.name.includes('Google')
            ) || voices[0];
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            audioIndicator.classList.add('active');
            
            utterance.onstart = () => {
                console.log('Speaking:', number);
            };
            
            utterance.onend = () => {
                console.log('Finished speaking:', number);
                audioIndicator.classList.remove('active');
            };
            
            utterance.onerror = (event) => {
                console.error('Speech error during trial:', event);
                audioIndicator.classList.remove('active');
            };
            
            speechSynthesis.speak(utterance);
        };
        
        // Speak warmup first
        setTimeout(() => {
            speechSynthesis.speak(warmup);
        }, 50);
    }

    // Update statistics
    function updateStats() {
        trialsCount.textContent = currentTrial;
    }

    // Run trial
    function runTrial() {
        if (!isRunning) return;

        currentTrial++;

        // Determine digit using history-aware logic
        let digit;
        const n = parseInt(nBackLevel.value);

        if (history.length >= n) {
            const target = history[history.length - n];
            const roll = Math.random();

            if (roll < 0.30) {
                // 30%: exact match (n-back hit)
                digit = target;
            } else if (roll < 0.50) {
                // 20%: near-miss â€” target Â±1 (cognitive interference)
                const nearMisses = [];
                if (target - 1 >= 1) nearMisses.push(target - 1);
                if (target + 1 <= 9) nearMisses.push(target + 1);
                digit = nearMisses[Math.floor(Math.random() * nearMisses.length)];
            } else {
                // 50%: random, excluding target AND its neighbors
                const excluded = new Set([target]);
                if (target - 1 >= 1) excluded.add(target - 1);
                if (target + 1 <= 9) excluded.add(target + 1);
                const candidates = [];
                for (let i = 1; i <= 9; i++) {
                    if (!excluded.has(i)) candidates.push(i);
                }
                digit = candidates[Math.floor(Math.random() * candidates.length)];
            }

            // Consecutive repeat guard â€” re-pick if digit equals previous
            // Exception: n=1 exact match IS a consecutive repeat by definition
            if (history.length > 0 && digit === history[history.length - 1] && !(roll < 0.30 && n === 1)) {
                const prev = history[history.length - 1];
                const excluded = new Set([prev, target]);
                if (target - 1 >= 1) excluded.add(target - 1);
                if (target + 1 <= 9) excluded.add(target + 1);
                const repickCandidates = [];
                for (let i = 1; i <= 9; i++) {
                    if (!excluded.has(i)) repickCandidates.push(i);
                }
                if (repickCandidates.length > 0) {
                    digit = repickCandidates[Math.floor(Math.random() * repickCandidates.length)];
                }
            }
        } else {
            // Not enough history yet â€” pure random, but avoid consecutive repeat
            digit = randomDigit();
            if (history.length > 0 && digit === history[history.length - 1]) {
                const repickCandidates = [];
                for (let i = 1; i <= 9; i++) {
                    if (i !== digit) repickCandidates.push(i);
                }
                digit = repickCandidates[Math.floor(Math.random() * repickCandidates.length)];
            }
        }

        history.push(digit);
        
        // Speak the number
        speakNumber(digit);

        // Update breath phase
        if (breathSync.checked) {
            breathPhase = breathPhase === 'inhale' ? 'exhale' : 'inhale';
            breathIndicator.textContent = breathPhase === 'inhale' ? 'â†‘ Inhale' : 'â†“ Exhale';
        }

        updateStats();

        // Schedule next trial
        const interval = parseFloat(intervalSlider.value) * 1000;
        trialTimeout = setTimeout(() => {
            runTrial();
        }, interval);
    }

    // Start game
    // Start game
    function startGame() {
        // Initialize audio system with user gesture
        speechSynthesis.cancel();
        
        // Prime the audio with instant silent utterance
        const primer = new SpeechSynthesisUtterance('');
        primer.volume = 0;
        speechSynthesis.speak(primer);
        
        // Start countdown immediately
        let countdown = 3;
        instructionText.textContent = countdown;
        
        const countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                instructionText.textContent = countdown;
            } else {
                clearInterval(countdownInterval);
                instructionText.textContent = 'Listen...';
                
                // Initialize
                isRunning = true;
                currentTrial = 0;
                history = [];
                breathPhase = 'inhale';
                
                updateStats();
                
                // Enable controls
                startBtn.disabled = true;
                stopBtn.disabled = false;
                nBackLevel.disabled = true;
                intervalSlider.disabled = true;
                speechRate.disabled = true;
                
                if (breathSync.checked) {
                    breathIndicator.textContent = 'â†‘ Inhale';
                }
                
                // Start first trial
                runTrial();
            }
        }, 1000);
    }

    // Stop game
    function stopGame() {
        isRunning = false;
        
        if (trialTimeout) {
            clearTimeout(trialTimeout);
            trialTimeout = null;
        }
        
        // Stop any ongoing speech
        speechSynthesis.cancel();
        
        instructionText.textContent = 'Press Start to begin';
        breathIndicator.textContent = '';
        audioIndicator.classList.remove('active');
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        nBackLevel.disabled = false;
        intervalSlider.disabled = false;
        speechRate.disabled = false;
    }

    // Event listeners
    startBtn.addEventListener('click', startGame);
    stopBtn.addEventListener('click', stopGame);

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (e.key === ' ') {
            e.preventDefault();
            if (!startBtn.disabled) {
                startGame();
            } else if (!stopBtn.disabled) {
                stopGame();
            }
        }
    });
</script>
```

</body>
</html>
