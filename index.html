<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fluid Intelligence N-Back</title>
    <style>
        :root {
            --bg: #F5F5F7;
            --surface: #FFFFFF;
            --primary: #0071e3;
            --primary-hover: #0077ED;
            --text: #1d1d1f;
            --text-secondary: #86868b;
            --border: #d2d2d7;
            --success: #34C759;
            --error: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }

        .interface {
            width: 100%;
            max-width: 440px;
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 40px;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 600px;
            transition: all 0.3s ease;
        }

        /* Typography */
        h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; text-align: center; letter-spacing: -0.01em; }
        h2 { font-size: 15px; font-weight: 500; color: var(--text-secondary); margin: 0 0 40px 0; text-align: center; }

        /* Inputs */
        .input-group { margin-bottom: 24px; }
        .label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
        .label-title { font-size: 14px; font-weight: 600; color: var(--text); }
        .label-value { font-size: 14px; font-weight: 600; color: var(--primary); font-family: monospace; }

        /* Custom Range Slider */
        input[type="range"] {
            width: 100%; height: 4px; background: var(--border); border-radius: 2px; appearance: none; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 20px; height: 20px; background: var(--surface); 
            border: 0.5px solid rgba(0,0,0,0.1); box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            border-radius: 50%; cursor: pointer; transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* Numeric Input (Trials) */
        .numeric-input {
            width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border);
            border-radius: 10px; text-align: center; font-weight: 600; color: var(--text);
            outline: none; transition: border-color 0.2s; -moz-appearance: textfield;
        }
        .numeric-input:focus { border-color: var(--primary); }
        .numeric-input::-webkit-outer-spin-button,
        .numeric-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Buttons */
        .btn {
            width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 17px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { background: var(--primary-hover); transform: scale(0.98); }
        .btn-ghost { background: transparent; color: var(--primary); margin-top: 10px; }
        
        .pause-btn {
            position: absolute; top: 20px; right: 20px; background: #f0f0f0; border: none;
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 12px; font-weight: bold;
            color: var(--text); display: flex; align-items: center; justify-content: center;
        }

        /* Screens */
        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* Game Elements */
        .game-header { text-align: center; margin-bottom: auto; margin-top: 20px; }
        .progress-text { font-size: 13px; color: var(--text-secondary); letter-spacing: 0.5px; font-weight: 600; }
        
        .visualizer {
            flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        
        .pulse-core {
            width: 100px; height: 100px; border-radius: 50%; background: var(--primary);
            opacity: 0; transform: scale(0.8); transition: all 0.1s ease-out;
        }
        .pulse-core.active { opacity: 0.2; transform: scale(1.2); }

        .feedback-text {
            position: absolute; font-size: 24px; font-weight: 800; letter-spacing: -0.5px;
            opacity: 0; transform: translateY(10px); transition: all 0.2s ease;
        }
        .feedback-text.show { opacity: 1; transform: translateY(0); }
        .feedback-text.match { color: var(--success); }
        .feedback-text.miss { color: var(--error); }

        .match-button-area { margin-top: auto; }
        .btn-match {
            height: 80px; background: white; border: 2px solid var(--border); color: var(--text); font-size: 20px;
        }
        .btn-match.active { background: #eef7ff; border-color: var(--primary); color: var(--primary); }

        /* Results */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0; }
        .stat-box { background: #f9f9fa; padding: 20px; border-radius: 16px; text-align: center; }
        .stat-num { font-size: 28px; font-weight: 700; color: var(--text); display: block; margin-bottom: 4px; }
        .stat-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }

        .paused-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; flex-direction: column;
            border-radius: 20px; z-index: 10;
        }
        .paused-overlay.visible { display: flex; }

    </style>
</head>
<body>

<div class="interface">
    
    <!-- SETUP SCREEN -->
    <div id="screen-setup" class="screen active">
        <h1>Fluid N-Back</h1>
        <h2>Configurable Intelligence Trainer</h2>

        <div class="input-group">
            <div class="label-row">
                <span class="label-title">N-Level (Memory Depth)</span>
                <span class="label-value" id="val-n">2</span>
            </div>
            <!-- CHANGED: Max N increased to 15 -->
            <input type="range" id="input-n" min="1" max="15" value="2" oninput="UI.updateN(this.value)">
        </div>

        <div class="input-group">
            <div class="label-row">
                <span class="label-title">Total Trials (10 - 5000)</span>
            </div>
            <input type="number" id="input-trials" class="numeric-input" min="10" max="5000" value="20">
        </div>

        <div class="input-group">
            <div class="label-row">
                <span class="label-title">Speed (Seconds per Trial)</span>
                <span class="label-value" id="val-speed">2.5s</span>
            </div>
            <input type="range" id="input-speed" min="1000" max="4000" step="100" value="2500" oninput="UI.updateSpeed(this.value)">
        </div>

        <div style="margin-top: auto;">
            <button class="btn btn-primary" onclick="Game.init()">Start Session</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="screen">
        <button class="pause-btn" onclick="Game.pause()">II</button>
        
        <div class="game-header">
            <div class="progress-text">TRIAL <span id="disp-current">1</span> OF <span id="disp-total">20</span></div>
        </div>

        <div class="visualizer">
            <div class="feedback-text" id="feedback">MATCH</div>
            <div class="pulse-core" id="pulse"></div>
        </div>

        <div class="match-button-area">
            <button class="btn btn-match" id="btn-match" onmousedown="Game.handleInput()" ontouchstart="Game.handleInput(event)">
                Match (Spacebar)
            </button>
        </div>

        <!-- PAUSE OVERLAY -->
        <div id="overlay-pause" class="paused-overlay">
            <h1>Paused</h1>
            <button class="btn btn-primary" style="width: 200px;" onclick="Game.resume()">Resume</button>
            <button class="btn btn-ghost" style="width: 200px;" onclick="Game.quit()">Quit Session</button>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="screen-results" class="screen">
        <h1>Session Complete</h1>
        <h2 id="res-level">N-Level 2</h2>

        <div class="stats-grid">
            <div class="stat-box">
                <span class="stat-num" id="res-accuracy">0%</span>
                <span class="stat-label">Accuracy</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="res-targets">0/0</span>
                <span class="stat-label">Targets Caught</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="res-errors">0</span>
                <span class="stat-label">False Alarms</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="res-lures">0</span>
                <span class="stat-label">Lure Fails</span>
            </div>
        </div>

        <div style="margin-top: auto;">
            <button class="btn btn-primary" onclick="UI.showScreen('setup')">New Session</button>
        </div>
    </div>
</div>

<script>
/**
 * AUDIO ENGINE
 * Handles browser-specific quirks and garbage collection issues.
 */
const AudioEngine = {
    synth: window.speechSynthesis,
    voices: [],
    activeUtterance: null, // Critical: prevents garbage collection during playback

    init() {
        // Silent play to unlock audio context on iOS/Chrome
        if (this.synth.speaking) this.synth.cancel();
        const u = new SpeechSynthesisUtterance("");
        this.synth.speak(u);
        
        // Load voices
        const load = () => {
            const all = this.synth.getVoices();
            // Prioritize US English for clarity
            this.voices = all.sort((a, b) => {
                const aScore = (a.lang === 'en-US' ? 2 : 0) + (a.name.includes('Google') ? 1 : 0);
                const bScore = (b.lang === 'en-US' ? 2 : 0) + (b.name.includes('Google') ? 1 : 0);
                return bScore - aScore;
            });
        };
        
        if (this.synth.onvoiceschanged !== undefined) {
            this.synth.onvoiceschanged = load;
        }
        load();
    },

    speak(char) {
        if (this.synth.speaking) this.synth.cancel();

        const u = new SpeechSynthesisUtterance(char);
        u.voice = this.voices[0] || null;
        u.rate = 1.2;
        u.pitch = 1.0;
        
        // Visual Sync
        u.onstart = () => document.getElementById('pulse').classList.add('active');
        u.onend = () => {
            document.getElementById('pulse').classList.remove('active');
            this.activeUtterance = null; // Release memory
        };

        // Anchor to global scope to prevent Chrome GC bug
        this.activeUtterance = u; 
        this.synth.speak(u);
    }
};

/**
 * GENERATOR
 * Deterministic Deck System for N-Back
 */
const Generator = {
    pool: ['H', 'K', 'L', 'M', 'R', 'S', 'T', 'W'], // High phonetic distinctiveness

    create(n, total) {
        // Validation: Ensure active trials is positive
        if (total <= n) {
            total = n + 10;
        }

        const seq = new Array(total).fill(null);
        const types = new Array(total).fill(null);
        
        // Weights
        const activeCount = total - n;
        const targetCount = Math.max(1, Math.ceil(activeCount * 0.33)); // 33% Targets
        const lureCount = Math.floor(activeCount * 0.15);   // 15% Lures
        const noiseCount = activeCount - targetCount - lureCount;

        // Create Deck
        let deck = [
            ...Array(targetCount).fill('target'),
            ...Array(lureCount).fill('lure'),
            ...Array(noiseCount).fill('noise')
        ];
        
        // Shuffle (Fisher-Yates)
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        // Fill Buffer (First N)
        for (let i = 0; i < n; i++) {
            seq[i] = this.getSafeChar([], null); 
            types[i] = 'buffer';
        }

        // Fill Active Trials
        for (let i = 0; i < deck.length; i++) {
            const idx = n + i;
            const type = deck[i];
            const targetChar = seq[idx - n]; // N-back letter

            let char = '';

            if (type === 'target') {
                char = targetChar;
            } 
            else if (type === 'lure') {
                // Attempt N-1 lure
                const lureSource = seq[idx - 1];
                if (lureSource && lureSource !== targetChar) {
                    char = lureSource;
                } else {
                    // Fallback to noise if lure is invalid (would create a match)
                    char = this.getSafeChar(this.pool, targetChar);
                }
            } 
            else { // Noise
                // STRICT RULE: Noise cannot equal Target
                char = this.getSafeChar(this.pool, targetChar);
            }

            seq[idx] = char;
            types[idx] = type;
        }

        return { seq, types, actualTotal: total };
    },

    getSafeChar(pool, exclude) {
        const valid = this.pool.filter(c => c !== exclude);
        return valid[Math.floor(Math.random() * valid.length)];
    }
};

/**
 * GAME CONTROLLER
 */
const Game = {
    config: { n: 2, trials: 20, speed: 2500 },
    state: {
        index: -1,
        sequence: [],
        types: [],
        responses: [],
        timer: null,
        isPaused: false
    },

    init() {
        // Parse Inputs
        const nInput = document.getElementById('input-n').value;
        const trialsInput = document.getElementById('input-trials').value;
        const speedInput = document.getElementById('input-speed').value;

        this.config.n = parseInt(nInput);
        let reqTrials = parseInt(trialsInput);

        // Auto-fix trials count if it's too small for the requested N
        if (reqTrials < this.config.n + 5) {
            reqTrials = this.config.n + 5;
            document.getElementById('input-trials').value = reqTrials;
        }

        this.config.trials = Math.max(this.config.n + 5, Math.min(5000, reqTrials));
        this.config.speed = parseInt(speedInput);

        // Wake Audio
        AudioEngine.init();

        // Generate Data
        const data = Generator.create(this.config.n, this.config.trials);
        this.state.sequence = data.seq;
        this.state.types = data.types;
        // Update config total in case Generator adjusted it
        this.config.trials = data.actualTotal; 
        
        this.state.responses = new Array(this.config.trials).fill(null);
        this.state.index = -1;
        this.state.isPaused = false;

        // UI Setup
        document.getElementById('disp-total').innerText = this.config.trials;
        UI.showScreen('game');
        
        // Start
        setTimeout(() => this.nextStep(), 1000);
    },

    nextStep() {
        if (this.state.isPaused) return;

        this.state.index++;

        // End Check
        if (this.state.index >= this.config.trials) {
            this.finish();
            return;
        }

        // Update UI
        document.getElementById('disp-current').innerText = this.state.index + 1;
        UI.resetFeedback();

        // Audio
        const char = this.state.sequence[this.state.index];
        AudioEngine.speak(char);

        // Schedule Next
        this.state.timer = setTimeout(() => this.nextStep(), this.config.speed);
    },

    handleInput(e) {
        if(e) e.preventDefault();
        if (this.state.isPaused) return;
        
        const idx = this.state.index;
        
        // Validations
        if (idx < this.config.n) return; // Buffer period
        if (this.state.responses[idx]) return; // Already answered

        // Logic
        const isMatch = this.state.sequence[idx] === this.state.sequence[idx - this.config.n];
        this.state.responses[idx] = isMatch ? 'hit' : 'falseAlarm';

        // Feedback
        UI.showFeedback(isMatch);
    },

    pause() {
        this.state.isPaused = true;
        clearTimeout(this.state.timer);
        document.getElementById('overlay-pause').classList.add('visible');
    },

    resume() {
        this.state.isPaused = false;
        document.getElementById('overlay-pause').classList.remove('visible');
        // Add slight delay before resuming
        setTimeout(() => this.nextStep(), 500);
    },

    quit() {
        this.state.isPaused = false;
        document.getElementById('overlay-pause').classList.remove('visible');
        UI.showScreen('setup');
    },

    finish() {
        UI.showScreen('results');
        
        let hits = 0;
        let targets = 0;
        let falseAlarms = 0;
        let lureFails = 0;
        let activeDecisions = 0;
        let correctDecisions = 0;

        for (let i = this.config.n; i < this.config.trials; i++) {
            const type = this.state.types[i];
            const resp = this.state.responses[i];
            
            activeDecisions++;

            if (type === 'target') {
                targets++;
                if (resp === 'hit') { hits++; correctDecisions++; }
            } else {
                // Noise or Lure
                if (resp !== 'falseAlarm') correctDecisions++; // Correct Rejection
                else falseAlarms++;

                if (type === 'lure' && resp === 'falseAlarm') {
                    lureFails++;
                }
            }
        }

        const accuracy = activeDecisions > 0 ? Math.round((correctDecisions / activeDecisions) * 100) : 0;

        document.getElementById('res-level').innerText = `N-Level ${this.config.n}`;
        document.getElementById('res-accuracy').innerText = `${accuracy}%`;
        document.getElementById('res-targets').innerText = `${hits}/${targets}`;
        document.getElementById('res-errors').innerText = falseAlarms;
        document.getElementById('res-lures').innerText = lureFails;
    }
};

/**
 * UI CONTROLLER
 */
const UI = {
    updateN(val) { document.getElementById('val-n').innerText = val; },
    updateSpeed(val) { document.getElementById('val-speed').innerText = (val/1000).toFixed(1) + 's'; },
    
    showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(`screen-${id}`).classList.add('active');
    },

    showFeedback(isMatch) {
        const el = document.getElementById('feedback');
        const btn = document.getElementById('btn-match');
        
        el.innerText = isMatch ? "MATCH!" : "WRONG";
        el.className = `feedback-text show ${isMatch ? 'match' : 'miss'}`;
        btn.classList.add('active');
    },

    resetFeedback() {
        document.getElementById('feedback').className = 'feedback-text';
        document.getElementById('btn-match').classList.remove('active');
    }
};

// Keyboard Listener
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        if(document.getElementById('screen-game').classList.contains('active')) {
            Game.handleInput();
        }
    }
});

</script>
</body>
</html>
